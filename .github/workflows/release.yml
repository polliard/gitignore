name: Release

on:
    push:
        tags:
            - "v*"

permissions:
    contents: write

jobs:
    test:
        name: Test
        runs-on: ubuntu-latest
        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Set up Go
              uses: actions/setup-go@v5
              with:
                  go-version: "1.21"

            - name: Download dependencies
              run: go mod download

            - name: Run tests
              run: make test

    build:
        name: Build
        needs: test
        runs-on: ubuntu-latest
        strategy:
            matrix:
                include:
                    - goos: darwin
                      goarch: amd64
                      suffix: darwin-amd64
                      archive: tar.gz
                    - goos: darwin
                      goarch: arm64
                      suffix: darwin-arm64
                      archive: tar.gz
                    - goos: linux
                      goarch: amd64
                      suffix: linux-amd64
                      archive: tar.gz
                    - goos: windows
                      goarch: amd64
                      suffix: windows-amd64
                      archive: zip
                      ext: .exe

        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Set up Go
              uses: actions/setup-go@v5
              with:
                  go-version: "1.21"

            - name: Get version from tag
              id: get_version
              run: echo "VERSION=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT

            - name: Build binary
              env:
                  GOOS: ${{ matrix.goos }}
                  GOARCH: ${{ matrix.goarch }}
              run: |
                  mkdir -p dist
                  go build -ldflags "-X main.version=${{ steps.get_version.outputs.VERSION }}" \
                    -o dist/gitignore${{ matrix.ext }} ./src/cmd/gitignore

            - name: Create archive (tar.gz)
              if: matrix.archive == 'tar.gz'
              run: |
                  cd dist
                  tar -czf gitignore-${{ steps.get_version.outputs.VERSION }}-${{ matrix.suffix }}.tar.gz gitignore${{ matrix.ext }}

            - name: Create archive (zip)
              if: matrix.archive == 'zip'
              run: |
                  cd dist
                  zip gitignore-${{ steps.get_version.outputs.VERSION }}-${{ matrix.suffix }}.zip gitignore${{ matrix.ext }}

            - name: Upload artifact
              uses: actions/upload-artifact@v4
              with:
                  name: gitignore-${{ matrix.suffix }}
                  path: dist/gitignore-${{ steps.get_version.outputs.VERSION }}-${{ matrix.suffix }}.${{ matrix.archive }}

    release:
        name: Create Release
        needs: build
        runs-on: ubuntu-latest
        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Get version from tag
              id: get_version
              run: echo "VERSION=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT

            - name: Download all artifacts
              uses: actions/download-artifact@v4
              with:
                  path: artifacts

            - name: Create source archive
              run: |
                  git archive --format=tar.gz --prefix=gitignore-${{ steps.get_version.outputs.VERSION }}/ \
                    -o artifacts/gitignore-${{ steps.get_version.outputs.VERSION }}-source.tar.gz HEAD

            - name: List artifacts
              run: find artifacts -type f

            - name: Create Release
              uses: softprops/action-gh-release@v1
              with:
                  name: Release ${{ steps.get_version.outputs.VERSION }}
                  draft: false
                  prerelease: false
                  generate_release_notes: true
                  files: |
                      artifacts/**/*.tar.gz
                      artifacts/**/*.zip
              env:
                  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
